# WebGatewayç”¨ã‚³ãƒ³ãƒ†ãƒŠã®HTTPSåŒ–ï¼‹IRISã¸ã®æ¥ç¶šã‚µãƒ³ãƒ—ãƒ«

- â€»1 ã‚µãƒ³ãƒ—ãƒ«ã§ã¯è£½å“ç‰ˆ iris:2023.1.1.380.0 ã‚’åˆ©ç”¨ã—ã¦ã„ã¾ã™ã€‚ï¼ˆè£½å“ç‰ˆåˆ©ç”¨æ™‚ã¯ [iris](/iris/)ä»¥ä¸‹ã« iris.keyã‚’é…ç½®ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ã‚­ãƒ¼ã¯ã‚³ãƒ³ãƒ†ãƒŠãƒ“ãƒ«ãƒ‰æ™‚ã«æœ‰åŠ¹åŒ–ã•ã‚Œã¾ã™ã€‚ï¼‰
- â€»2 ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ã‚¨ãƒ‡ã‚£ã‚·ãƒ§ãƒ³ã«å¤‰æ›´ã™ã‚‹å ´åˆã¯ã€[docker-compose.yml](docker-compose.yml) 19è¡Œç›®ã‚’ã‚³ãƒ¡ãƒ³ãƒˆåŒ–ã—ã¦ãã ã•ã„ã€‚ã¾ãŸã€IRISã®[Dockerfile](/iris/Dockerfile)ã®FROMã‚’é©åˆ‡ãªã‚¤ãƒ¡ãƒ¼ã‚¸ã«å¤‰æ›´ã—ã¦ãã ã•ã„ã€‚

## ã‚³ãƒ³ãƒ†ãƒŠã®é–‹å§‹

```
docker-compose up -d --build
```
Apacheã‚³ãƒ³ãƒ†ãƒŠå†…ã®80ãƒãƒ¼ãƒˆã¯ãƒ›ã‚¹ãƒˆã®**8080**ã«ã€443ã¯**8443**ã‚’ä½¿ç”¨ã™ã‚‹ã‚ˆã†ã«è¨˜è¿°ã—ã¦ã„ã¾ã™ã€‚

ã‚µãƒ³ãƒ—ãƒ«ã® [docker-compose.yml](/docker-compose.yml) ã‚’ä¿®æ­£ã›ãšã«ãã®ã¾ã¾ã‚³ãƒ³ãƒ†ãƒŠã‚’é–‹å§‹ã—ãŸå ´åˆã¯ã€ç®¡ç†ãƒãƒ¼ã‚¿ãƒ«ã¸ã¯ä»¥ä¸‹ã®URLã§ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™ã€‚

é€šä¿¡æ–¹å¼|URL
--|--
http|http://localhost:8080/csp/sys/UtilHome.csp
https|https://localhost:8443/csp/sys/UtilHome.csp

ãƒ¦ãƒ¼ã‚¶åï¼šSuperUserã€ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼šSYSã€€ã§ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™ã€‚

## ã‚³ãƒ³ãƒ†ãƒŠåœæ­¢

```
docker-compose stop
```

## ã‚³ãƒ³ãƒ†ãƒŠå‰Šé™¤
```
docker-compose down
```
___

**ã€WebGatewayç”¨ã‚³ãƒ³ãƒ†ãƒŠã«ã¤ã„ã¦è£œè¶³ã€‘**

ã‚µãƒ³ãƒ—ãƒ«ã§ã¯ã€ä¸‹è¨˜ã‚³ãƒ³ãƒ†ãƒŠã‚’åˆ©ç”¨ã€‚ã‚³ãƒ³ãƒ†ãƒŠå®Ÿè¡Œã§80ãƒãƒ¼ãƒˆã®ApacheãŒç«‹ã¡ä¸ŠãŒã‚‹ã€‚

`containers.intersystems.com/intersystems/webgateway:2023.1.1.380.0`


## 1) WebGatewayç”¨ã‚³ãƒ³ãƒ†ãƒŠã®confãƒ•ã‚¡ã‚¤ãƒ«ã‚’å¤‰æ›´ã™ã‚‹

WebGatewayç”¨ã‚³ãƒ³ãƒ†ãƒŠèµ·å‹•æ™‚ã€IRISç”¨ã®è¨­å®šãŒå¿…è¦ã«ãªã‚‹ã®ã§ã€/ ã®ãƒ‘ã‚¹ãŒæ¥ãŸã¨ãApacheã‹ã‚‰Webã‚²ãƒ¼ãƒˆã‚¦ã‚§ã‚¤ã«è»¢é€ã•ã‚Œã‚‹ã‚ˆã†ã«è¨­å®šã‚’è¿½åŠ ã™ã‚‹ã€‚

è¿½åŠ å†…å®¹ã¯[CSP.conf](/webgateway/CSP.conf)ã®ä¸­èº«

> â€»å‚è€ƒã«ã—ãŸãƒšãƒ¼ã‚¸ï¼š[https://github.com/intersystems-community/webgateway-examples](https://github.com/intersystems-community/webgateway-examples)


## 2) Webã‚²ãƒ¼ãƒˆã‚¦ã‚§ã‚¤ã‹ã‚‰IRISã¸æ¥ç¶šã™ã‚‹ãŸã‚ã®è¨­å®šè¿½åŠ 

ï¼ˆãƒ¡ãƒ¢ï¼šApacheã‚³ãƒ³ãƒ†ãƒŠç«‹ã¡ä¸Šã’å¾Œã«æ‰‹å‹•ã§Webã‚²ãƒ¼ãƒˆã‚¦ã‚§ã‚¤ç®¡ç†ç”»é¢ã§ã‚‚è¨­å®šã§ãã‚‹ã€€ğŸ‘‰ã€€[http://webã‚µãƒ¼ãƒå/csp/bin/Systems/Module.cxw](http://localhost:8080/csp/bin/Systems/Module.cxw)ï¼‰

> ã“ã®ã‚³ãƒ³ãƒ†ãƒŠã¯80ãƒãƒ¼ãƒˆã‚’ãƒ›ã‚¹ãƒˆã®**8080**ã«å‰²ã‚Šå½“ã¦ã¦ã„ã¾ã™ã€‚

CSP.iniãƒ•ã‚¡ã‚¤ãƒ«ã®ä¸­èº«ã‚’æ›¸ãæ›ãˆã‚Œã°ã‚ˆã„ã®ã§ã€æ›¸ãæ›ãˆã®ä¸­èº«ã®ã¿ã‚’ [CSP.ini](/webgateway/CSP.ini)ã«ç”¨æ„

ã‚³ãƒ³ãƒ†ãƒŠã§ã¯CSP.iniãƒ•ã‚¡ã‚¤ãƒ«ã¯Webã‚²ãƒ¼ãƒˆã‚¦ã‚§ã‚¤ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä»¥ä¸‹ã«é…ç½®ã•ã‚Œã‚‹ã€‚

ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¯ç’°å¢ƒå¤‰æ•° **${ISC_PACKAGE_INSTALLDIR}** ã§ç¢ºèªã§ãã‚‹ã€‚

```
root@318a6f20db77:/opt/webgateway# ls ${ISC_PACKAGE_INSTALLDIR}/bin/CSP.ini
/opt/webgateway/bin/CSP.ini
```

ã“ã“ã¾ã§ã§ã€80ï¼ˆãƒ›ã‚¹ãƒˆå´ã¯8080ï¼‰ã§IRISã¸æ¥ç¶šã‚’è¡Œã†è¨­å®šã¯å®Œäº†ã€‚

ï¼œãƒ¡ãƒ¢1ï¼
ã‚µãƒ³ãƒ—ãƒ«ã§ã¯ã€æ¥ç¶šå…ˆã‚‚ã‚³ãƒ³ãƒ†ãƒŠã®IRISã‚’æŒ‡ã—ã¦ã„ã‚‹ã€‚

- æ¥ç¶šå…ˆIRISã®ãƒ›ã‚¹ãƒˆåï¼š**iris4h**
- ã‚¹ãƒ¼ãƒ‘ãƒ¼ã‚µãƒ¼ãƒãƒ¼ãƒãƒ¼ãƒˆï¼š**1972**
- ã‚¢ã‚¯ã‚»ã‚¹ãƒ¦ãƒ¼ã‚¶åï¼š**CSPSystem**
- ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼š**SYS**
- CSP.iniã«è¨˜è¼‰ã™ã‚‹IRISã¸ã®æ¥ç¶šåã¯ **[LOCAL]** ã‚’åˆ©ç”¨ã€‚ã‚µãƒ¼ãƒåã¨ã—ã¦è¨­å®šã—ãŸ[LOCAL]ã«å¯¾ã—ã¦ã€**LOCAL=Enabled** ã®è¨˜è¿°ã‚‚å¿…è¦
- **æ¥ç¶šå…ˆIRISã®CSPSystemã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒã‚µãƒ³ãƒ—ãƒ«ã¨ç•°ãªã‚‹å ´åˆã¯ã€ [CSP.ini](/webgateway/CSP.ini)20è¡Œç›®ã®å¤‰æ›´ãŒå¿…è¦ã€‚**

ï¼œãƒ¡ãƒ¢2ï¼
IRISã‚³ãƒ³ãƒ†ãƒŠå´ã§ã¯ã€ã‚³ãƒ³ãƒ†ãƒŠãƒ“ãƒ«ãƒ‰æ™‚äº‹å‰å®šç¾©ãƒ¦ãƒ¼ã‚¶ã«å¯¾ã™ã‚‹ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’SYSã«å›ºå®šã¨ã—ã¦ã„ã¾ã™ã€‚é©å®œå¤‰æ›´ãŠé¡˜ã„ã—ã¾ã™ã€‚
>IRISã‚³ãƒ³ãƒ†ãƒŠãƒ“ãƒ«ãƒ‰æ™‚ã«å®Ÿè¡Œã•ã‚Œã‚‹[Dockerfile](/iris/Dockerfile) ã§å®Ÿè¡Œã—ã¦ã„ã‚‹ [iris.script](/iris/iris.script)å†…ã§ã€åˆå›ã‚¢ã‚¯ã‚»ã‚¹æ™‚ã®äº‹å‰å®šç¾©ãƒ¦ãƒ¼ã‚¶ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®å¤‰æ›´æ‰‹ç¶šãã‚’ç„¡åŠ¹ã«ã—ã¦ã„ã¾ã™ã€‚

___
ä»¥ä¸‹ã€HTTPSã§ç®¡ç†ãƒãƒ¼ã‚¿ãƒ«ã«æ¥ç¶šã—ãŸã„å ´åˆã®è¨­å®š


## 3) HTTPSé€šä¿¡ç”¨ã«è¨¼æ˜æ›¸ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æº–å‚™

ã‚µãƒ³ãƒ—ãƒ«ã§ã¯ã‚ªãƒ¬ã‚ªãƒ¬è¨¼æ˜æ›¸ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æº–å‚™
- [server.crt](/webgateway/server.crt)
- [server.key](/webgateway/server.key)

key ã¯ãƒ‘ã‚¹ãƒ•ãƒ¬ãƒ¼ã‚ºãŒèã‹ã‚Œãªã„ã‚ˆã†ã«å¤‰æ›´ã—ãŸã»ã†ãŒè‰¯ã„ã€‚
> openssl rsa -in ã‚­ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ« -out ã‚­ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«

## 4) Apacheã®SSLåŒ–

[3) HTTPSé€šä¿¡ç”¨ã«è¨¼æ˜æ›¸ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æº–å‚™](#3-httpsé€šä¿¡ç”¨ã«è¨¼æ˜æ›¸ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æº–å‚™) ã®ãƒ•ã‚¡ã‚¤ãƒ«é©ç”¨ã®ãŸã‚ã€[docker-compose.yml](/docker-compose.yml) ã¨ [CSP.conf](/webgateway/CSP.conf) ã«å°‚ç”¨ã®è¨˜è¿°ã‚’è¿½åŠ 

    â€»docker-compose.ymlã®volumesã®è¨­å®šã§ã€[webgateway](/webgateway/)ä»¥ä¸‹ã«é…ç½®ã—ãŸã‚­ãƒ¼ã‚„iniã€confãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚³ãƒ³ãƒ†ãƒŠå†…ã®ã€Œwebgateway-sharedã€ã«é…ç½®ã•ã‚Œã€SSLåŒ–ã‚‚[CSP.conf](/webgateway/CSP.conf)ã®é€šã‚Šã«è¨­å®šã•ã‚Œã¾ã™ã€‚

- [docker-compose.yml](/docker-compose.yml) ã®webgwã‚³ãƒ³ãƒ†ãƒŠã«2ç¨®ã®ç’°å¢ƒå¤‰æ•°ã¨volumeã®è¨­å®šã‚’è¡Œã†

    ```
    environment:
    - ISC_CSP_CONF_FILE=/webgateway-shared/CSP.conf
    - ISC_CSP_INI_FILE=/webgateway-shared/CSP.ini
    volumes:
    - ./webgateway:/webgateway-shared
    ```

- [CSP.conf](/webgateway/CSP.conf)

    ```
    SSLCertificateFile "/webgateway-shared/server.crt"
    SSLCertificateKeyFile "/webgateway-shared/server.key"
    ```

ã‚ã¨ã¯ã‚³ãƒ³ãƒ†ãƒŠã‚’é–‹å§‹ã™ã‚‹ã ã‘ã§httpsã§IRISã®ç®¡ç†ãƒãƒ¼ã‚¿ãƒ«ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™ã€‚
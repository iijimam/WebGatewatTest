Apacheã‚³ãƒ³ãƒ†ãƒŠã®ä¸­ã®GWã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¯ä»¥ä¸‹
root@56e5a720e80d:/etc/apache2/mods-available# echo ${ISC_PACKAGE_INSTALLDIR}
/opt/webgateway
root@56e5a720e80d:/etc/apache2/mods-available#


${ISC_PACKAGE_INSTALLDIR}ã€€ã§ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªç¢ºèªã§ãã‚‹

CSP.iniã®ã²ãªå½¢ä½œã£ã¦ãŠã„ã¦cat ã§ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã™ã‚‹æ–¹æ³•ã‚’ä½¿ã£ãŸã‘ã©ã€
[SYSTEM_INDEX]ã€€ä»¥é™ã®è¡Œã‹ã‚‰æ›¸ã‹ãªã„ã¨ãƒ€ãƒ–ã£ã¦ã—ã¾ã†


â˜…â˜…ã€€2023/8/18ã€€WebGatewayç”¨ã‚³ãƒ³ãƒ†ãƒŠã®SSLåŒ–ã¯ã“ã‚ŒãŒå‚è€ƒ
https://github.com/intersystems-community/webgateway-examples/tree/master
https://github.com/intersystems-community/webgateway-examples/blob/master/demo-compose/webgateway/CSP.conf



--------ä»¥ä¸‹ã€ä½¿ã£ã¦ãªã„ã‘ã©æ®‹ã—ã¨ã

SSLåŒ–ã®ãƒ’ãƒ³ãƒˆã¯ã“ã“
https://www.server-world.info/query?os=Ubuntu_22.04&p=httpd&f=3

a2ensite default-ssl
ã¨
a2enmod ssl

web\Dockerfileã®ä¸­ã§ä»¥ä¸‹å®Ÿè¡Œï¼ˆ.keyã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’èã‹ã‚Œãªã„ã‚ˆã†ã«ã—ã¦ãŠã‹ãªã„ã¨å‹•ã‹ãªã„ï¼‰

    cp /etc/apache2/mods-available/webgwfiles/server.crt /etc/ssl/certs/server.crt && \
    cp /etc/apache2/mods-available/webgwfiles/server.key /etc/ssl/private/server.key && \
        -> ã‚ªãƒ¬ã‚ªãƒ¬è¨¼æ˜æ›¸ã‚’ssl-confã§ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§æŒ‡å®šã•ã‚Œã¦ã„ã‚‹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã‚³ãƒ”ãƒ¼ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¨ã¯ãƒ•ã‚¡ã‚¤ãƒ«åãŒé•ã†ï¼‰
        
    cp /etc/apache2/sites-available/default-ssl.conf /etc/apache2/sites-available/default-ssl-bck.conf && \

        -> ãƒ•ã‚¡ã‚¤ãƒ«åã‚’ã‚³ãƒ”ãƒ¼ã—ãŸè¨¼æ˜æ›¸ã«æ›¸ãæ›ãˆã‚‹ã®ã§ã‚ªãƒªã‚¸ãƒŠãƒ«ã‚’ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã—ã¦ãŠã
    
    sed -e 's/ssl-cert-snakeoil.pem/server.crt/g' /etc/apache2/sites-available/default-ssl.conf > /etc/apache2/sites-available/default-ssl2.conf && \
    sed -e 's/ssl-cert-snakeoil.key/server.key/g' /etc/apache2/sites-available/default-ssl2.conf > /etc/apache2/sites-available/default-ssl.conf && \

        â†’ã€€ssl-cert-snakeoil.pemã€€ã‚’ server.crt ã«
        ã€€ssl-cert-snakeoil.keyã€€ã‚’ server.keyã«ã€€ç½®æ›

    a2ensite default-ssl && \
        â†’ã€€SSLè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®æœ‰åŠ¹åŒ–

    a2enmod ssl
        â†’ã€€a2enmodã‚³ãƒãƒ³ãƒ‰ã¯ã€åˆ©ç”¨å¯èƒ½ãªãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‹ã‚‰ã€æŒ‡å®šã—ãŸãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®èª­ã¿è¾¼ã¿ã‚’æœ‰åŠ¹ã«ã™ã‚‹ã‚‚ã®ã§ã™ã€‚ã€€sslã ã‘æœ‰åŠ¹ã«ã™ã‚‹ã¨ã„ã†æ„å‘³ï¼Ÿ
            ã“ã‚Œã‚’å®Ÿè¡Œã™ã‚‹ã¨ mods-availableã®ä¸­ã«ã€ssl.confã€€ãŒå­˜åœ¨ã™ã‚‹ï¼ˆã‚‚ã¨ã‚‚ã¨ã‚ã‚‹ããŒã™ã‚‹ï¼‰

æ‰‹å‹•ã ã¨Apacheå†èµ·å‹•ã ã‘ã©ã€ã“ã‚Œã‹ã‚‰ã‚³ãƒ³ãƒ†ãƒŠãŒé–‹å§‹ã™ã‚‹ã®ã§ã“ã‚Œã§OK


======== ä»¥ä¸‹ã€å…ƒreadme.mdã®ä¸­èº« ========
IRISã®ç®¡ç†ãƒãƒ¼ã‚¿ãƒ«ç”¨ã«ã“ã®Apacheã‚’åˆ©ç”¨ã™ã‚‹ãŸã‚ã«ã¯ã€IRISã¸æ¥ç¶šã‚’è¡Œã†ãŸã‚ã®ãƒ‘ã‚¹ã®è¿½åŠ ãŒå¿…è¦ã€‚

## 1) Apacheã‚³ãƒ³ãƒ†ãƒŠã®confãƒ•ã‚¡ã‚¤ãƒ«ã‚’å¤‰æ›´ã™ã‚‹

Apacheã‚³ãƒ³ãƒ†ãƒŠèµ·å‹•æ™‚ã€ä»¥ä¸‹ã«IRISç”¨ã®confãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã™ã‚‹ã€‚

`/etc/apache2/mods-available/CSP.conf`

ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®çŠ¶æ…‹ã§ã¯IRISã®ç®¡ç†ãƒãƒ¼ã‚¿ãƒ«ç”¨è¨­å®šãŒè¡Œã‚ã‚Œã¦ã„ãªã„ãŸã‚ã€/ ã®ãƒ‘ã‚¹ãŒæ¥ãŸã¨ãApacheã‹ã‚‰Webã‚²ãƒ¼ãƒˆã‚¦ã‚§ã‚¤ã«è»¢é€ã•ã‚Œã‚‹ã‚ˆã†ã«è¨­å®šã‚’è¿½åŠ ã™ã‚‹ã€‚

è¿½åŠ å†…å®¹ã¯[webgateway.conf](/web/webgwfiles/webgateway.conf)ã®ä¸­èº«

Apacheç”¨[Dockerfile](/web/Dockerfile) ã®RUNã®è¡Œã§CSP.confã«[webgateway.conf](/web/webgwfiles/webgateway.conf)ã®ä¸­èº«ã‚’è¿½è¨˜ã—ã¦ã„ã‚‹ï¼ˆ5è¡Œç›®ï¼‰ã€‚

## 2) Webã‚²ãƒ¼ãƒˆã‚¦ã‚§ã‚¤ã‹ã‚‰IRISã¸æ¥ç¶šã™ã‚‹ãŸã‚ã®è¨­å®šè¿½åŠ 

ï¼ˆãƒ¡ãƒ¢ï¼šApacheã‚³ãƒ³ãƒ†ãƒŠç«‹ã¡ä¸Šã’å¾Œã«æ‰‹å‹•ã§Webã‚²ãƒ¼ãƒˆã‚¦ã‚§ã‚¤ç®¡ç†ç”»é¢ã§ã‚‚è¨­å®šã§ãã‚‹ã€€ğŸ‘‰ã€€[http://webã‚µãƒ¼ãƒå/csp/bin/Systems/Module.cxw](http://localhost:8080/csp/bin/Systems/Module.cxw)ï¼‰

> ã“ã®ã‚³ãƒ³ãƒ†ãƒŠã¯80ãƒãƒ¼ãƒˆã‚’ãƒ›ã‚¹ãƒˆã®**8080**ã«å‰²ã‚Šå½“ã¦ã¦ã„ã¾ã™ã€‚

CSP.iniãƒ•ã‚¡ã‚¤ãƒ«ã®ä¸­èº«ã‚’æ›¸ãæ›ãˆã‚Œã°ã‚ˆã„ã®ã§ã€æ›¸ãæ›ãˆã®ä¸­èº«ã®ã¿ã‚’ [CSP.ini](/web/webgwfiles/CSP.ini)ã«ç”¨æ„

ã‚³ãƒ³ãƒ†ãƒŠã§ã¯CSP.iniãƒ•ã‚¡ã‚¤ãƒ«ã¯Webã‚²ãƒ¼ãƒˆã‚¦ã‚§ã‚¤ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä»¥ä¸‹ã«é…ç½®ã•ã‚Œã‚‹ã€‚

ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¯ç’°å¢ƒå¤‰æ•° **${ISC_PACKAGE_INSTALLDIR}** ã§ç¢ºèªã§ãã‚‹ã€‚

```
root@318a6f20db77:/opt/webgateway# ls ${ISC_PACKAGE_INSTALLDIR}/bin/CSP.ini
/opt/webgateway/bin/CSP.ini
```
ã‚³ãƒ³ãƒ†ãƒŠãƒ“ãƒ«ãƒ‰æ™‚ã€IRISã¸ã®æ¥ç¶šè¨­å®šã‚’ **${ISC_PACKAGE_INSTALLDIR}/bin/CSP.ini** ã«è¿½è¨˜ã™ã‚‹ã‚ˆã†ã« Apacheç”¨[Dockerfile](/web/Dockerfile) ã®6è¡Œç›®ã®RUNã‚³ãƒãƒ³ãƒ‰ã§å®Ÿè¡Œï¼ˆå®Ÿè¡Œå†…å®¹ã¯ä»¥ä¸‹ï¼‰
```
cat /etc/apache2/mods-available/webgwfiles/CSP.ini >> ${ISC_PACKAGE_INSTALLDIR}/bin/CSP.ini && \
```

ã“ã“ã¾ã§ã§ã€80ï¼ˆãƒ›ã‚¹ãƒˆå´ã¯8080ï¼‰ã§IRISã¸æ¥ç¶šã‚’è¡Œã†è¨­å®šã¯å®Œäº†ã€‚

ï¼œãƒ¡ãƒ¢1ï¼
ã‚µãƒ³ãƒ—ãƒ«ã§ã¯ã€æ¥ç¶šå…ˆã‚‚ã‚³ãƒ³ãƒ†ãƒŠã®IRISã‚’æŒ‡ã—ã¦ã„ã‚‹ã€‚

- æ¥ç¶šå…ˆIRISã®ãƒ›ã‚¹ãƒˆåï¼š**iris4h**
- ã‚¹ãƒ¼ãƒ‘ãƒ¼ã‚µãƒ¼ãƒãƒ¼ãƒãƒ¼ãƒˆï¼š**1972**
- ã‚¢ã‚¯ã‚»ã‚¹ãƒ¦ãƒ¼ã‚¶åï¼š**CSPSystem**
- ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼š**SYS**
- CSP.iniã«è¨˜è¼‰ã™ã‚‹IRISã¸ã®æ¥ç¶šåã¯ **[LOCAL]** ã‚’åˆ©ç”¨ã€‚ã‚µãƒ¼ãƒåã¨ã—ã¦è¨­å®šã—ãŸ[LOCAL]ã«å¯¾ã—ã¦ã€**LOCAL=Enabled** ã®è¨˜è¿°ã‚‚å¿…è¦
- **æ¥ç¶šå…ˆIRISã®CSPSystemã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒã‚µãƒ³ãƒ—ãƒ«ã¨ç•°ãªã‚‹å ´åˆã¯ã€ [CSP.ini](/web/webgwfiles/CSP.ini) 16è¡Œç›®ã®å¤‰æ›´ãŒå¿…è¦ã€‚**

ï¼œãƒ¡ãƒ¢2ï¼
IRISã‚³ãƒ³ãƒ†ãƒŠå´ã§ã¯ã€ã‚³ãƒ³ãƒ†ãƒŠãƒ“ãƒ«ãƒ‰æ™‚äº‹å‰å®šç¾©ãƒ¦ãƒ¼ã‚¶ã«å¯¾ã™ã‚‹ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’SYSã«å›ºå®šã¨ã—ã¦ã„ã¾ã™ã€‚é©å®œå¤‰æ›´ãŠé¡˜ã„ã—ã¾ã™ã€‚
>IRISã‚³ãƒ³ãƒ†ãƒŠãƒ“ãƒ«ãƒ‰æ™‚ã«å®Ÿè¡Œã•ã‚Œã‚‹[Dockerfile](/iris/Dockerfile) ã§å®Ÿè¡Œã—ã¦ã„ã‚‹ [iris.script](/iris/iris.script)å†…ã§ã€åˆå›ã‚¢ã‚¯ã‚»ã‚¹æ™‚ã®äº‹å‰å®šç¾©ãƒ¦ãƒ¼ã‚¶ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®å¤‰æ›´æ‰‹ç¶šãã‚’ç„¡åŠ¹ã«ã—ã¦ã„ã¾ã™ã€‚

___
ä»¥ä¸‹ã€HTTPSã§ç®¡ç†ãƒãƒ¼ã‚¿ãƒ«ã«æ¥ç¶šã—ãŸã„å ´åˆã®è¨­å®š


## 3) HTTPSé€šä¿¡ç”¨ã«è¨¼æ˜æ›¸ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æº–å‚™

ã‚µãƒ³ãƒ—ãƒ«ã§ã¯ã‚ªãƒ¬ã‚ªãƒ¬è¨¼æ˜æ›¸ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æº–å‚™
- [server.crt](/web/webgwfiles/server.crt)
- [server.key](/web/webgwfiles/server.key)

key ã¯ãƒ‘ã‚¹ãƒ•ãƒ¬ãƒ¼ã‚ºãŒèã‹ã‚Œãªã„ã‚ˆã†ã«å¤‰æ›´ã—ãŸã»ã†ãŒè‰¯ã„ã€‚
> openssl rsa -in ã‚­ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ« -out ã‚­ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«

## 4) Apacheã®SSLåŒ–

[3) HTTPSé€šä¿¡ç”¨ã«è¨¼æ˜æ›¸ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æº–å‚™](#3-httpsé€šä¿¡ç”¨ã«è¨¼æ˜æ›¸ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æº–å‚™) ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã€default-ssl.conf ã§æŒ‡å®šã•ã‚Œã¦ã„ã‚‹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã‚³ãƒ”ãƒ¼ã—ã¦ã„ã¾ã™ã€‚

default-ssl.confã¯Apacheã‚³ãƒ³ãƒ†ãƒŠèµ·å‹•æ™‚ã€ä»¥ä¸‹ã«ã‚ã‚Šã¾ã™ã€‚
> /etc/apache2/sites-available/default-ssl.conf

ãã‚Œãã‚Œã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä»¥ä¸‹ã«é…ç½®
ãƒ•ã‚¡ã‚¤ãƒ«å|é…ç½®å ´æ‰€
--|--|
server.crt|/etc/ssl/certs/server.crt
server.key|/etc/ssl/private/server.key

default-ssl.confã‚’æ›¸ãæ›ãˆã‚‹ãŸã‚ã€ã‚ªãƒªã‚¸ãƒŠãƒ«ã‚’ã‚³ãƒ”ãƒ¼ã—ã€ä»¥ä¸‹ã®é …ç›®åã«ç”¨æ„ã—ãŸè¨¼æ˜æ›¸ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ•ãƒ«ãƒ‘ã‚¹ã‚’è¨­å®š


é …ç›®å|ãƒ•ã‚¡ã‚¤ãƒ«æŒ‡å®š
--|--|
SSLCertificateFile|/etc/ssl/certs/server.crt
SSLCertificateKeyFile|/etc/ssl/private/server.key

ã“ã‚Œã‚‰ã®æ–‡å­—åˆ—ã®åŠ å·¥ã¯ã€Apacheã®[Dockerfile](/web/Dockerfile) ã®RUNã‚³ãƒãƒ³ãƒ‰ï¼ˆ7è¡Œç›®ä»¥é™ï¼‰ã§å®Ÿè¡Œã—ã¦ã„ã¾ã™ã€‚

default-ssl.confã®æ›¸ãæ›ãˆãŒçµ‚äº†ã—ãŸã‚‰ã€Apacheã®[Dockerfile](/web/Dockerfile) ã®RUNã‚³ãƒãƒ³ãƒ‰ï¼ˆ13ï½14è¡Œç›®ï¼‰ã§SSLè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®æœ‰åŠ¹åŒ–ã‚’è¡Œã†ãŸã‚ã€ä»¥ä¸‹å®Ÿè¡Œã—ã¦ã„ã¾ã™ã€‚
```
a2ensite default-ssl
a2enmod ssl
```

ã‚³ãƒ³ãƒ†ãƒŠãƒ“ãƒ«ãƒ‰æ™‚ã«ä¸Šè¨˜è¨­å®šãŒå®Œäº†ã™ã‚‹ãŸã‚ã€ã‚ã¨ã¯ã‚³ãƒ³ãƒ†ãƒŠã‚’é–‹å§‹ã™ã‚‹ã ã‘ã§httpsã§IRISã®ç®¡ç†ãƒãƒ¼ã‚¿ãƒ«ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™ã€‚


=============================================================================
ç¾åœ¨æœªä½¿ç”¨ï¼ˆWebGatewaySSLåŒ–ã®ã‚³ãƒ¼ãƒ‰ã‚’ã¹ãŸæ›¸ãã—ãŸç‰ˆã®Dockerfile for webgwï¼‰
FROM containers.intersystems.com/intersystems/webgateway:2022.2.0.372.0

COPY webgwfiles /etc/apache2/mods-available/webgwfiles

RUN cat /etc/apache2/mods-available/webgwfiles/webgateway.conf >> /etc/apache2/mods-available/CSP.conf &&\
    cat /etc/apache2/mods-available/webgwfiles/CSP.ini >> ${ISC_PACKAGE_INSTALLDIR}/bin/CSP.ini && \
    cp /etc/apache2/mods-available/webgwfiles/server.crt /etc/ssl/certs/server.crt && \
    cp /etc/apache2/mods-available/webgwfiles/server.key /etc/ssl/private/server.key && \
    cp /etc/apache2/sites-available/default-ssl.conf /etc/apache2/sites-available/default-ssl-bck.conf && \
    sed -e 's/ssl-cert-snakeoil.pem/server.crt/g' /etc/apache2/sites-available/default-ssl.conf > /etc/apache2/sites-available/default-ssl2.conf && \
    sed -e 's/ssl-cert-snakeoil.key/server.key/g' /etc/apache2/sites-available/default-ssl2.conf > /etc/apache2/sites-available/default-ssl.conf && \
    rm /etc/apache2/sites-available/default-ssl2.conf && \
    a2ensite default-ssl && \
    a2enmod ssl

